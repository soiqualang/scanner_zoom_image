<link href="style.css" type="text/css" rel="stylesheet">
<div>
    <div class="row flex" style="position:relative;">
        <input type="text" name="" id="url1" placeholder="URL" class="item">
        <input type="text" name="" id="url2" placeholder="URL 2 (Optional)" class="item">
        <div id="selector"></div>
    </div>
    <div class="container">
        <div id="zoom" class="magnify-wrapper magnify">
            <img src="" id="main-img" />
        </div>
        <div id="preview" class="magnify-preview magnify"></div>
    </div>
</div>
<script src="data.js"></script>
<script>
    let imgbox = document.getElementById("main-img");
    let urlbox1= document.getElementById("url1");
    let urlbox2= document.getElementById("url2");
    let selector =document.getElementById("selector");
    start();

    function start(){
        let item = null;
        if(typeof data!=="undefined" && data.length){
            item = data[0];
            imgbox.src = item[0];
            urlbox1.value = item[0];
            urlbox2.value = item[1]?item[1]:"";
        }
        magnify("#zoom", 2, item?item[1]:null, "#preview");
        createSelector();
    }
    function createSelector(){
        if(typeof data==="undefined") return;
        for(let item of data){
            let html = `<div class="sel" data-url="${item[0]}" data-url2="${item[1]?item[1]:item[0]}">
            <span style="margin-right:10px;width:50px;max-height:100%;"><img class="imgsel" src="${item[0]}"></span>
            <span>${item[0]}</span>
            </div>`;
            let div=document.createElement("div");
            div.innerHTML = html;
            selector.appendChild(div.children[0]);
        }
    }
    function magnify(zoomSel, zoom = 3, src =null, preview = null) {
        let pin =false;
        let root = document.querySelector(zoomSel);
        let original = root.querySelector("img");
        let magnified;
        preview = preview ? (typeof preview==="string"?document.querySelector(preview):preview):null;
        if(!src){
            src =  original.src;
        }
        magnified = document.createElement("div");
        magnified.id = "glasses";
        magnified.classList.add("glasses")
        root.appendChild(magnified);
        magnified.style.backgroundImage = "url("+src+")";
        let imgpreview = null;
        if(preview){
            preview.classList.add("magnify-preview");

            // imgpreview= document.createElement("div");
            // imgpreview.id= "imgpreview";
            // imgpreview.classList.add("magnify-imgpreview");
            // preview.appendChild(imgpreview);
            // imgpreview.style.backgroundImage = "url("+src+")";

            imgpreview= document.createElement("img");
            imgpreview.id= "imgpreview";
            imgpreview.classList.add("magnify-imgpreview2");
            preview.appendChild(imgpreview);
            imgpreview.src = src;

            imgpreview.style.transform = "scale("+zoom+")";
            imgpreview.style.transformOrigin = "0px 0px";
        }
        root.addEventListener("mousemove", onMouseMove, false);
        root.addEventListener("contextmenu", onPin, false);
        root.addEventListener("click", onClick, false);
        function onClick(e){
            let p = pin;
            pin = false;
            onMouseMove.bind(root)(e);
            pin = p;
        }
        function onPin(e){
            e.preventDefault();
            e.stopPropagation();
            pin = !pin;
            if(!pin){
                onMouseMove(e);
            }
        }
        function onMouseMove(e) {
            if(pin) return;
            let pos = this.getBoundingClientRect();
            let style = magnified.style,
                x = e.clientX - pos.left,
                y = e.clientY - pos.top,
                w = original.width,
                h = original.height,
                xperc = (x / w) * 100,
                yperc = (y / h) * 100;
            // Add some margin for right edge
            if (x > 0.01 * w) {
                xperc += 0.15 * xperc;
            }
            // Add some margin for bottom edge
            if (y >= 0.01 * h) {
                yperc += 0.15 * yperc;
            }

            // Set the background of the magnified image horizontal
            style.backgroundPositionX = xperc - 9 + "%";
            // Set the background of the magnified image vertical
            style.backgroundPositionY = yperc - 9 + "%";
            if(preview){
                // imgpreview.style.backgroundPositionX = xperc - 9 + "%";
                // imgpreview.style.backgroundPositionY = yperc - 9 + "%";
                let pw = preview.offsetWidth;
                let ph = preview.offsetHeight;
                let iw = imgpreview.offsetWidth;
                let ih = imgpreview.offsetHeight;
                let dx= pw/2-x/w*(iw*zoom);
                let dy = ph/2-y/h*(ih*zoom);
                imgpreview.style.top = dy+"px";
                imgpreview.style.left = dx+"px";
            }
            // Move the magnifying glass with the mouse movement.
            style.left = x + "px";
            style.top = y + "px";
        }
    }
    selector.addEventListener("click", function(e){
        let elm = e.target.closest(".sel");
        if(elm){
            e.preventDefault();
            e.stopPropagation();
            urlbox1.value = elm.dataset.url;
            urlbox2.value = elm.dataset.url2;
            urlChange.bind(urlbox1)();
            selector.style.display = "none";
        }
    })
    urlbox1.addEventListener("click", showSelector);
    urlbox2.addEventListener("click", showSelector);
    function showSelector(e){
        e.preventDefault();
        e.stopPropagation();
        // let pos = this.getBoundingClientRect();
        let pos={
            width: this.offsetWidth,
            height: this.offsetHeight,
            top: this.offsetTop,
            left: this.offsetLeft,
        };
        selector.style.width = pos.width;
        selector.style.top = pos.top + pos.height;
        selector.style.left = pos.left;
        selector.style.display = "block";
    }
    document.documentElement.addEventListener("click", function(e){
        selector.style.display = "none";
    })
    urlbox1.addEventListener("input", urlChange)
    function urlChange(e){
        let url = this.value.trim();
        if(!url) return;
        document.getElementById("main-img").src = url;
        let url2= urlbox2.value.trim();
        if(!url2) url2 = url;
        document.getElementById("glasses").style.backgroundImage = "url("+url2+")";
        document.getElementById("imgpreview").src = url2;
    }
    urlbox2.addEventListener("input", function(e){
        let url = this.value.trim();
        if(!url) {
            url = urlbox1.value.trim();
        }
        document.getElementById("glasses").style.backgroundImage = "url("+url+")";
        document.getElementById("imgpreview").src = url;
    })
</script>