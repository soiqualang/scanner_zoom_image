<style>
    * {
        box-sizing: border-box;
    }
    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        display: flex;
        flex-wrap: nowrap;
        position: relative;
    }
    .magnify-preview{
        height: 100%;
        background-repeat: no-repeat;
        background-color: #fff;
        overflow: hidden;
        position: relative;
    }
    .magnify-imgpreview{
        background-repeat: no-repeat;
        background-color: #fff;
        max-width: 100%;
        max-height: 100%;
        width: 100%;
        height: 100%;
    }
    .magnify-imgpreview2{
        position: absolute;
    }
    .magnify{
        flex: 1 0 50%;
        max-width: 50%;
        max-height: 100%;
    }
    #main-img{
        max-width: 100%;
        max-height: 100%;
    }
    .magnify-wrapper {
        position: relative;
        /* max-height: 50vh; */
    }

    .magnify-wrapper img {
        max-height: inherit;
    }

    .magnify-wrapper .glasses {
        background-repeat: no-repeat;
        background-color: #fff;
        width: 200px;
        height: 200px;
        box-shadow: 0 5px 10px -2px rgba(0, 0, 0, 0.3);
        pointer-events: none;
        position: absolute;
        border: 4px solid #efefef;
        z-index: 99;
        border-radius: 100%;
        display: block;
        opacity: 0;
        transition: opacity 0.2s;
        transform: translate(-50%, -50%);
    }

    .magnify-wrapper:hover .glasses,
    .magnify-wrapper:active .glasses {
        opacity: 1;
    }
    .row{
        display: block;
        margin-bottom: 5px;
    }
    input{
        padding:4px 6px;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin: 4px;
    }
    .flex{
        display: flex;
    }
    .item{
        flex: 1;
    }
    #selector{
        padding: 10px;
        z-index: 9999;
        position: absolute;
        display: none;
        background-color: #ccc;
        border: 1px solid #ccc;
        border-radius: 5px;
        max-height: 600px;
        overflow-y: auto;
    }
    .sel{
        display: block;
        width: 100%;
        overflow: hidden;
        padding: 5px;
        border-bottom: 1px solid #ccc;
        text-overflow: ellipsis;
        display: flex;
        max-height: 50px;
    }
    .imgsel{
        width: 50px;
        height: 50px;
    }
</style>
<div>
    <div class="row flex" style="position:relative;">
        <input type="text" name="" id="url1" placeholder="URL" class="item">
        <input type="text" name="" id="url2" placeholder="URL 2 (Optional)" class="item">
        <div id="selector"></div>
    </div>
    <div class="container">
        <div id="zoom" class="magnify-wrapper magnify">
            <img src="" id="main-img" />
        </div>
        <div id="preview" class="magnify-preview magnify"></div>
    </div>
</div>
<script src="/data.js"></script>
<script>
    let imgbox = document.getElementById("main-img");
    let urlbox1= document.getElementById("url1");
    let urlbox2= document.getElementById("url2");
    let selector =document.getElementById("selector");
    start();

    function start(){
        let item = null;
        if(typeof data!=="undefined" && data.length){
            item = data[0];
            imgbox.src = item[0];
            urlbox1.value = item[0];
            urlbox2.value = item[1]?item[1]:"";
        }
        magnify("#zoom", 2, item?item[1]:null, "#preview");
        createSelector();
    }
    function createSelector(){
        if(typeof data==="undefined") return;
        for(let item of data){
            let html = `<div class="sel" data-url="${item[0]}" data-url2="${item[1]?item[1]:item[0]}">
            <span style="margin-right:10px;width:50px;max-height:100%;"><img class="imgsel" src="${item[0]}"></span>
            <span>${item[0]}</span>
            </div>`;
            let div=document.createElement("div");
            div.innerHTML = html;
            selector.appendChild(div.children[0]);
        }
    }
    function magnify(zoomSel, zoom = 3, src =null, preview = null) {
        let pin =false;
        let root = document.querySelector(zoomSel);
        let original = root.querySelector("img");
        let magnified;
        preview = preview ? (typeof preview==="string"?document.querySelector(preview):preview):null;
        if(!src){
            src =  original.src;
        }
        magnified = document.createElement("div");
        magnified.id = "glasses";
        magnified.classList.add("glasses")
        root.appendChild(magnified);
        magnified.style.backgroundImage = "url("+src+")";
        let imgpreview = null;
        if(preview){
            preview.classList.add("magnify-preview");

            // imgpreview= document.createElement("div");
            // imgpreview.id= "imgpreview";
            // imgpreview.classList.add("magnify-imgpreview");
            // preview.appendChild(imgpreview);
            // imgpreview.style.backgroundImage = "url("+src+")";

            imgpreview= document.createElement("img");
            imgpreview.id= "imgpreview";
            imgpreview.classList.add("magnify-imgpreview2");
            preview.appendChild(imgpreview);
            imgpreview.src = src;

            imgpreview.style.transform = "scale("+zoom+")";
            imgpreview.style.transformOrigin = "0px 0px";
        }
        root.addEventListener("mousemove", onMouseMove, false);
        root.addEventListener("contextmenu", onPin, false);
        root.addEventListener("click", onClick, false);
        function onClick(e){
            let p = pin;
            pin = false;
            onMouseMove(e);
            pin = p;
        }
        function onPin(e){
            e.preventDefault();
            e.stopPropagation();
            pin = !pin;
            if(!pin){
                onMouseMove(e);
            }
        }
        function onMouseMove(e) {
            if(pin) return;
            let pos = this.getBoundingClientRect();
            let style = magnified.style,
                x = e.clientX - pos.left,
                y = e.clientY - pos.top,
                w = original.width,
                h = original.height,
                xperc = (x / w) * 100,
                yperc = (y / h) * 100;
            // Add some margin for right edge
            if (x > 0.01 * w) {
                xperc += 0.15 * xperc;
            }
            // Add some margin for bottom edge
            if (y >= 0.01 * h) {
                yperc += 0.15 * yperc;
            }

            // Set the background of the magnified image horizontal
            style.backgroundPositionX = xperc - 9 + "%";
            // Set the background of the magnified image vertical
            style.backgroundPositionY = yperc - 9 + "%";
            if(preview){
                // imgpreview.style.backgroundPositionX = xperc - 9 + "%";
                // imgpreview.style.backgroundPositionY = yperc - 9 + "%";
                let pw = preview.offsetWidth;
                let ph = preview.offsetHeight;
                let iw = imgpreview.offsetWidth;
                let ih = imgpreview.offsetHeight;
                let dx= pw/2-x/w*(iw*zoom);
                let dy = ph/2-y/h*(ih*zoom);
                imgpreview.style.top = dy+"px";
                imgpreview.style.left = dx+"px";
            }
            // Move the magnifying glass with the mouse movement.
            style.left = x + "px";
            style.top = y + "px";
        }
    }
    selector.addEventListener("click", function(e){
        let elm = e.target.closest(".sel");
        if(elm){
            e.preventDefault();
            e.stopPropagation();
            urlbox1.value = elm.dataset.url;
            urlbox2.value = elm.dataset.url2;
            urlChange.bind(urlbox1)();
            selector.style.display = "none";
        }
    })
    urlbox1.addEventListener("click", showSelector);
    urlbox2.addEventListener("click", showSelector);
    function showSelector(e){
        e.preventDefault();
        e.stopPropagation();
        // let pos = this.getBoundingClientRect();
        let pos={
            width: this.offsetWidth,
            height: this.offsetHeight,
            top: this.offsetTop,
            left: this.offsetLeft,
        };
        selector.style.width = pos.width;
        selector.style.top = pos.top + pos.height;
        selector.style.left = pos.left;
        selector.style.display = "block";
    }
    document.documentElement.addEventListener("click", function(e){
        selector.style.display = "none";
    })
    urlbox1.addEventListener("input", urlChange)
    function urlChange(e){
        let url = this.value.trim();
        if(!url) return;
        document.getElementById("main-img").src = url;
        let url2= document.getElementById("url2").value.trim();
        if(!url2) url2 = url;
        document.getElementById("glasses").style.backgroundImage = "url("+url2+")";
        document.getElementById("imgpreview").src = url2;
    }
    urlbox2.addEventListener("input", function(e){
        let url = this.value.trim();
        if(!url) {
            url = document.getElementById("url").value.trim();
        }
        document.getElementById("glasses").style.backgroundImage = "url("+url+")";
        document.getElementById("imgpreview").src = url;
    })
</script>